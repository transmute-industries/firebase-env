let TransmuteFramework = require("transmute-framework").default;
const path = require("path");

const functions = require("firebase-functions");
const admin = require("firebase-admin");

let config;
const detectedCloud = () => {
  try {
    config = functions.config();
    return true;
  } catch (e) {
    return false;
  }
};
const FRAMEWORK_ENV = detectedCloud() ? "NODE_CLOUD" : "NODE_LOCAL";
if (FRAMEWORK_ENV === "NODE_LOCAL") {
  const FRAMEWORK_ENV_PATH = path.join(
    process.cwd(),
    "{{{secretEnvPath}}}"
  );
  require("dotenv").config({ path: FRAMEWORK_ENV_PATH });
} else {
  // config will have the correct values...
}

{{#constDeclarations}} 
{{{.}}} 
{{/constDeclarations}}

if (FRAMEWORK_ENV === "NODE_LOCAL") {
  admin.initializeApp({
    credential: admin.credential.cert(
      require(GOOGLE_PROJECT_SERVICE_ACCOUNT_ABS_PATH)
    )
  });
}

if (FRAMEWORK_ENV === "NODE_CLOUD") {
  admin.initializeApp(functions.config().firebase);
}

let transmuteConfig = {
  providerUrl: "http://localhost:8545",
  aca: require("./build/contracts/RBAC.json"),
  esa: require("./build/contracts/RBACEventStore.json"),
  esfa: require("./build/contracts/RBACEventStoreFactory.json"),
  firebaseAdmin: admin
};

TransmuteFramework.init(transmuteConfig);

export default {
  TransmuteFramework,
  {{#constExports}} 
  {{{.}}},
  {{/constExports}}
};
